<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Sri Lakshmi Ganesh Auto Finance</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
/* Base Styles */
body { font-family: 'Inter', Arial, sans-serif; margin: 20px; background-color: #f7f9fc; color: #333; }
h1 { color: #0d6efd; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 15px; }
h1, h2, h3 { font-weight: bold; } 

.menu button { margin: 10px; padding: 12px 25px; font-size: 16px; cursor: pointer; background: #0d6efd; color: white; border: none; border-radius: 8px; transition: background-color 0.2s, transform 0.1s; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
.menu button:hover { background-color: #0b5ed7; transform: translateY(-1px); }
.home-btn { display: none; margin: 10px 0; padding: 8px 16px; background: #6c757d; color: white; border: none; cursor: pointer; border-radius: 5px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);}
.section { display: none; margin-top: 20px; padding: 20px; background-color: white; border-radius: 10px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);}
table { border-collapse: collapse; width: 100%; margin-top: 20px; border-radius: 8px; overflow: hidden; table-layout: fixed; } 
th, td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: middle; font-size: 14px; }
th { background-color: #f4f4f4; color: #333; font-weight: 600; }
#allVehicleTable tbody tr:hover { background-color: inherit; } 

input, textarea, select { margin: 5pt 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 100%; box-sizing: border-box; }
.form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;}
.form-grid label { display: flex; flex-direction: column; width: 100%; font-weight: 500; }
#addVehicle .form-grid label span { margin-bottom: 4px; font-size: 14px; color: #555; font-weight: bold; }

#vehicleForm button[type="submit"] {padding: 12px 30px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);}
#vehicleForm button[type="submit"]:hover { background-color: #218838; }

.details-row { background-color: #f0f8ff; border: 1px solid #cceeff; }
.details-row td { padding: 20px !important; }
.details-container { display: flex; flex-direction: column; gap: 20px; }
.details-container .info-wrapper { display: flex; flex-wrap: wrap; gap: 20px;}
.loan-details-box, .vehicle-details-box {border: 1px solid #b3d9ff; padding: 20px; background: #ffffff; flex: 1 1 300px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);}
.loan-details-box h3, .vehicle-details-box h3 { margin-top: 0; color: #0d6efd; font-size: 1.2em; border-bottom: 1px dashed #ddd; padding-bottom: 10px; margin-bottom: 15px; }
.details-container button { padding: 10px 20px; background-color: #ffc107; color: #333; border: none; border-radius: 5px; cursor: pointer; max-width: 200px; align-self: flex-start; font-weight: 600;}
.details-container button:hover { background-color: #e0a800;}

.noc-pdf-btn { padding: 6px 12px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em; white-space: nowrap;}
.noc-pdf-btn:hover { background-color: #c82333; }
.noc-na-text { display: inline-block; padding: 6px 12px; background-color: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6; border-radius: 4px; font-size: 0.85em; white-space: nowrap; font-weight: normal; }

#nocTemplateWrapper { position: absolute; left: -9999px; top: 0; }

.print-record {
    padding: 20px;
    background-color: #f0f8ff; 
    border: 1px solid #cceeff; 
    border-radius: 10px; 
    margin-bottom: 20px;
    page-break-after: always;
}
.print-record h2 { font-size: 1.5em; margin-bottom: 15px; border-bottom: 2px solid #ddd; padding-bottom: 5px; color: #0d6efd;}
.print-record .info-wrapper { display: flex; flex-wrap: wrap; gap: 20px;}
.print-record .loan-details-box, .print-record .vehicle-details-box {
    border: 1px solid #b3d9ff; padding: 15px; background: #ffffff; flex: 1 1 300px; border-radius: 8px;
    box-shadow: none; 
}
.print-record .loan-details-box h3, .print-record .vehicle-details-box h3 {
    margin-top: 0; color: #0d6efd; font-size: 1.2em; border-bottom: 1px dashed #ddd; padding-bottom: 10px; margin-bottom: 10px; 
}
.print-record strong { font-weight: bold; }
.print-record .details-container { display: flex; flex-direction: column; gap: 15px; }

@media (max-width: 768px) {
  .form-grid { grid-template-columns: 1fr; }
  .details-container .info-wrapper { flex-direction: column; }
  .loan-details-box, .vehicle-details-box { flex: 1 1 auto; }
  .section { margin: 10px; padding: 15px; }
  h1 { font-size: 1.5em; }
  .menu button { margin: 5px; padding: 10px 15px; font-size: 14px; }
  th, td { padding: 8px; font-size: 12px; }
}

.section-header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
.search-inline { display:flex; gap:8px; align-items:center; }
.print-btn { padding:8px 14px; background:#17a2b8; color:#fff; border:none; border-radius:6px; cursor:pointer; }
.print-btn:hover { background:#138496; }
#loginScreen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 40vh;}
#loginForm { background: white; padding: 30px; border-radius: 10pt; box-shadow: 0 0 15px rgba(0, 0, 0, 0.05); width: 100%; max-width: 350px;}
#loginForm input { margin-bottom: 15px;}
#loginForm button { width: 100%; padding: 12px 25px; background: #0d6efd; color: white; border: none; border-radius: 8px; cursor: pointer;}
#loginForm button:hover { background: #0b5ed7;}

#allVehicleTable th:nth-child(1) { width: 15%; text-align: left; } 
#allVehicleTable th:nth-child(2) { width: 25%; text-align: left; } 
#allVehicleTable th:nth-child(3) { width: 20%; text-align: left; } 
#allVehicleTable th:nth-child(4) { width: 20%; text-align: left; } 
#allVehicleTable th:nth-child(5) { width: 20%; text-align: center; } 

#nocConfirmationModal, #passwordResetModal {
    display: none; 
    position: fixed;
    z-index: 1001;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4); 
    padding-top: 60px;
}

.modal-content {
    background-color: #fefefe;
    margin: 10% auto; 
    padding: 30px;
    border: 1px solid #888;
    width: 90%; 
    max-width: 500px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    text-align: center;
}

.modal-content h3 {
    color: #0d6efd;
    margin-top: 0;
    font-size: 1.5em;
    border-bottom: 2px solid #eee;
    padding-bottom: 10px;
    margin-bottom: 20px;
}

.modal-buttons {
    margin-top: 30px;
    display: flex;
    justify-content: space-around;
}

.modal-buttons button {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    min-width: 100px;
}
</style>
</head>

<body>

<h1>Sri Lakshmi Ganesh Auto Finance</h1>
<button class="home-btn" onclick="goHome()">üè† Home</button>

<!-- LOGIN -->
<div id="loginScreen" style="display:flex;">
  <h2>Login</h2>
  <div id="loginForm">
    <label><span>Role:</span>
      <select id="roleInput" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ccc; border-radius:5px;">
        <option value="user">User</option>
        <option value="admin">Admin</option>
      </select>
    </label>

    <input type="password" id="passwordInput" placeholder="Password" required onkeyup="handleLoginKey(event)">
    <button onclick="login()">Login</button>

    <div style="text-align: center; margin-top: 15px;">
      <a href="javascript:void(0)" onclick="openResetModal()" style="color: #6c757d; font-size: 14px; text-decoration: underline;">
        Forgot Admin Password?
      </a>
    </div>
  </div>
</div>

<div id="home" class="menu" style="display:none;"></div>

<!-- VEHICLE DATA -->
<div id="vehicleData" class="section">
  <div class="section-header">
    <h2>All Vehicle Data</h2>
    <div style="display:flex; gap:12px; align-items:center;">
      <div class="search-inline">
        <input id="searchInputData" type="text" placeholder="Search Vehicle No., Name, Loan AG No., or NOC." style="padding:8px 10px; width:220px;" onkeyup="handleSearchKey(event)">
        <button onclick="searchInVehicleData()" style="padding:8px 10px; background:#0d6efd; color:#fff; border:none; border-radius:6px; cursor:pointer;">Search</button>
        <button onclick="resetVehicleDataSearch()" style="padding:8px 10pt; background:#6c757d; color:#fff; border:none; border-radius:6px; cursor:pointer;">Reset</button>
      </div>
      <button class="print-btn" onclick="printVehicleData()">Print</button>
    </div>
  </div>

  <table id="allVehicleTable">
    <thead>
      <tr>
        <th>Vehicle Number</th>
        <th>Name</th>
        <th>Loan AG Number</th>
        <th>NOC</th>
        <th style="text-align:center;">Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- ADD VEHICLE -->
<div id="addVehicle" class="section">
  <h2>Add New Vehicle</h2>
  <form id="vehicleForm" onsubmit="addVehicle(event)">
    <div class="form-grid">
      <label><span>Surname:</span> <input type="text" id="surname" required class="uppercase-input"></label>
      <label><span>Name:</span> <input type="text" id="firstName" required class="uppercase-input"></label>
      <label><span>Mobile (10 Digits):</span> <input type="text" id="phone" required maxlength="10" pattern="\d{10}" title="Mobile must be 10 digits" class="uppercase-input"></label>

      <label>
        <span onclick="toggleAddressFields()" style="cursor:pointer; font-weight:bold; color:#555; border-bottom: 1px dashed #ccc;">Address: (Click to Enter Details)</span>
        <input type="hidden" id="combinedAddress" required /> 
        <div id="addressFields" style="display:none; margin-top: 5px; background: #f7f7f7; padding: 10px; border-radius: 5px;">
          <label><span>H.No:</span> <input type="text" id="hNo" placeholder="House/Door Number" class="uppercase-input"></label>
          <label><span>Address Line:</span> <input type="text" id="addressLine" placeholder="Street/Area" class="uppercase-input"></label>
          <label><span>City:</span> <input type="text" id="city" placeholder="City" class="uppercase-input"></label>
          <label><span>Pin Code:</span> <input type="text" id="pinCode" placeholder="Pincode" class="uppercase-input"></label>
          <label><span>State:</span> <input type="text" id="state" value="" placeholder="State" class="uppercase-input"></label>
        </div>
      </label>

      <label><span>Vehicle Number:</span> <input type="text" id="vehicleNumber" required class="uppercase-input"></label>
      <label><span>Loan AG Number:</span> <input type="text" id="loanAg" required class="uppercase-input"></label>
      <label><span>Loan Date:</span> <input type="date" id="loanDate" required></label>

      <label>
        <span onclick="toggleGuarantorFields()" style="cursor:pointer; font-weight:bold; color:#555; border-bottom: 1px dashed #ccc;">Guarantor Details: (Click to Enter Details) - OPTIONAL</span>
        <input type="hidden" id="combinedGuarantor" />
        <div id="guarantorFields" style="display:none; margin-top: 5px; background: #f7f7f7; padding: 10pt; border-radius: 5px;">
          <label><span>Guarantor Surname:</span> <input type="text" id="guarantorSurname" placeholder="Guarantor Surname" class="uppercase-input"></label>
          <label><span>Guarantor Name:</span> <input type="text" id="guarantorName" placeholder="Guarantor Name" class="uppercase-input"></label>
          <label><span>Guarantor Loan AG Number:</span> <input type="text" id="guarantorLoanAg" placeholder="Guarantor Loan AG Number" class="uppercase-input"></label>
        </div>
      </label>

      <label><span>Maker:</span> <input type="text" id="maker" required class="uppercase-input"></label>
      <label><span>Classification:</span> <input type="text" id="classification" required class="uppercase-input"></label>
      <label><span>Model:</span> <input type="text" id="model" required class="uppercase-input"></label>
      <label><span>Chassis Number:</span> <input type="text" id="chassis" required class="uppercase-input"></label>
      <label><span>Engine Number:</span> <input type="text" id="engine" required class="uppercase-input"></label>
      <label><span>R.T.O:</span> <input type="text" id="rto" required class="uppercase-input"></label>
    </div>
    <button type="submit">Submit</button>
  </form>
</div>

<!-- OTP PASSWORD RESET MODAL -->
<div id="passwordResetModal">
  <div class="modal-content">
    <h3>Reset Admin Password</h3>

    <!-- Step 1 -->
    <div id="resetStepEmail">
      <p style="font-weight:bold; color:#555;">Enter Admin Email</p>
      <input type="email" id="adminEmailInput" placeholder="Enter Email">
      <button onclick="sendOTP()" style="margin-top:15px; background:#0d6efd; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer;">
        Send OTP
      </button>
    </div>

    <!-- Step 2 -->
    <div id="resetStepOTP" style="display:none;">
      <p style="font-weight:bold; color:#555;">Enter OTP</p>
      <input type="text" id="otpInput" placeholder="Enter OTP">
      <button onclick="verifyOTP()" style="margin-top:15px; background:#28a745; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer;">
        Verify OTP
      </button>
    </div>

    <!-- Step 3 -->
    <div id="resetStepNewPass" style="display:none;">
      <p style="font-weight:bold; color:#555;">Enter New Password</p>
      <input type="password" id="newPasswordInput" placeholder="New Password">
      <button onclick="saveNewPassword()" style="margin-top:15px; background:#28a745; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer;">
        Save Password
      </button>
    </div>

    <div style="margin-top:25px;">
      <button onclick="closeResetModal()" style="background:#dc3545; color:white; padding:10px 20px; border:none; border-radius:6px; cursor:pointer;">
        Cancel
      </button>
    </div>
  </div>
</div>

<script>
/* ===========================
   CONFIG
=========================== */
const API_BASE_URL = "http://localhost:5000/api/vehicles";
const SETTINGS_API_URL = "http://localhost:5000/api/settings/admin-password";
const OTP_API_URL = "http://localhost:5000/api/auth";

let ADMIN_PASSWORD = "Vehicle@2005";
const USER_PASSWORD = "User#08";

let vehicles = [];
let currentExpandedRow = null;
let userRole = null;
let currentVehicleToNOC = null;

let resetEmail = "";

/* ===========================
   LOAD ADMIN PASSWORD FROM DB
=========================== */
window.onload = async () => {
  try {
    const response = await fetch(SETTINGS_API_URL);
    const data = await response.json();
    if (data.password) ADMIN_PASSWORD = data.password;
  } catch (e) {
    console.error("Could not sync password.");
  }
};

/* ===========================
   UTILITIES
=========================== */
function showMessage(msg) {
  const notification = document.createElement("div");
  notification.style.cssText = `
    position: fixed; top: 20px; right: 20px;
    background-color: #0d6efd; color: white;
    padding: 10px 20px; border-radius: 5px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 9999;
  `;
  notification.textContent = msg;
  document.body.appendChild(notification);
  setTimeout(() => document.body.removeChild(notification), 3000);
}

function autoCapitalizeInput(e) {
  const input = e.target;
  input.value = input.value.toUpperCase();
}

document.addEventListener("input", (e) => {
  if (e.target.classList.contains("uppercase-input")) {
    autoCapitalizeInput(e);
  }
});

/* ===========================
   LOGIN
=========================== */
function handleLoginKey(event) {
  if (event.key === "Enter") login();
}

function handleSearchKey(event) {
  if (event.key === "Enter") searchInVehicleData();
}

function login() {
  const role = document.getElementById("roleInput").value;
  const password = document.getElementById("passwordInput").value.trim();

  if (role === "admin" && password === ADMIN_PASSWORD) {
    userRole = "admin";
    setupMenu("admin");
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("home").style.display = "block";
    showMessage("Admin Login Successful!");
  } else if (role === "user" && password === USER_PASSWORD) {
    userRole = "user";
    setupMenu("user");
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("home").style.display = "block";
    showMessage("User Login Successful!");
  } else {
    showMessage("Invalid Role or Password.");
  }
}

function setupMenu(role) {
  const menuDiv = document.getElementById("home");
  menuDiv.innerHTML = "";

  menuDiv.innerHTML += '<button onclick="showSection(\'addVehicle\')">Add New Vehicle</button>';
  menuDiv.innerHTML += '<button onclick="showSection(\'vehicleData\')">Vehicle Data</button>';

  if (role === "admin") {
    menuDiv.innerHTML += '<button onclick="deleteWithPassword()">‚ùå Delete Vehicle (Admin)</button>';
  }

  menuDiv.innerHTML += '<button onclick="logout()">üö™ Logout</button>';
}

function logout() {
  userRole = null;
  document.getElementById("loginScreen").style.display = "flex";
  document.getElementById("passwordInput").value = "";
  document.getElementById("home").style.display = "none";
  document.querySelector(".home-btn").style.display = "none";
  document.querySelectorAll(".section").forEach(s => s.style.display = "none");
  showMessage("Logged out.");
}

/* ===========================
   SECTIONS
=========================== */
function showSection(id) {
  document.querySelectorAll(".section").forEach(s => s.style.display = "none");
  document.getElementById("home").style.display = "none";
  document.querySelector(".home-btn").style.display = "inline-block";
  document.getElementById(id).style.display = "block";

  currentExpandedRow = null;

  if (id === "vehicleData") fetchAndRenderAllData();
}

function goHome() {
  document.querySelectorAll(".section").forEach(s => s.style.display = "none");
  document.getElementById("home").style.display = "block";
  document.querySelector(".home-btn").style.display = "none";

  if (document.getElementById("addressFields").style.display !== "none") toggleAddressFields(true);
  if (document.getElementById("guarantorFields").style.display !== "none") toggleGuarantorFields(true);
}

/* ===========================
   OTP RESET MODAL
=========================== */
function openResetModal() {
  document.getElementById("passwordResetModal").style.display = "block";

  document.getElementById("adminEmailInput").value = "";
  document.getElementById("otpInput").value = "";
  document.getElementById("newPasswordInput").value = "";

  document.getElementById("resetStepEmail").style.display = "block";
  document.getElementById("resetStepOTP").style.display = "none";
  document.getElementById("resetStepNewPass").style.display = "none";
}

function closeResetModal() {
  document.getElementById("passwordResetModal").style.display = "none";
}

async function sendOTP() {
  const email = document.getElementById("adminEmailInput").value.trim();

  if (!email) {
    showMessage("Enter email!");
    return;
  }

  try {
    const res = await fetch(`${OTP_API_URL}/send-otp`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email })
    });

    const data = await res.json();

    if (!res.ok) {
      showMessage(data.message || "Failed to send OTP.");
      return;
    }

    resetEmail = email;
    showMessage("OTP sent to email!");

    document.getElementById("resetStepEmail").style.display = "none";
    document.getElementById("resetStepOTP").style.display = "block";
  } catch (err) {
    console.error(err);
    showMessage("Server error while sending OTP.");
  }
}

async function verifyOTP() {
  const otp = document.getElementById("otpInput").value.trim();

  if (!otp) {
    showMessage("Enter OTP!");
    return;
  }

  try {
    const res = await fetch(`${OTP_API_URL}/verify-otp`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email: resetEmail, otp })
    });

    const data = await res.json();

    if (!res.ok) {
      showMessage(data.message || "Invalid OTP.");
      return;
    }

    showMessage("OTP verified! Enter new password.");

    document.getElementById("resetStepOTP").style.display = "none";
    document.getElementById("resetStepNewPass").style.display = "block";
  } catch (err) {
    console.error(err);
    showMessage("Server error while verifying OTP.");
  }
}

async function saveNewPassword() {
  const newPass = document.getElementById("newPasswordInput").value.trim();
  const otp = document.getElementById("otpInput").value.trim();

  if (newPass.length < 4) {
    showMessage("Password too short.");
    return;
  }

  try {
    const res = await fetch(SETTINGS_API_URL, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        email: resetEmail,
        otp: otp,
        newPassword: newPass
      })
    });

    const data = await res.json();

    if (!res.ok) {
      showMessage(data.message || "Failed to update password.");
      return;
    }

    ADMIN_PASSWORD = newPass;
    showMessage("Password Reset Successfully!");
    closeResetModal();
  } catch (e) {
    console.error(e);
    showMessage("Server error.");
  }
}

/* ===========================
   VEHICLE FETCH + TABLE
=========================== */
async function fetchAndRenderAllData() {
  try {
    const response = await fetch(API_BASE_URL);
    if (!response.ok) throw new Error("Failed to fetch data from server.");
    vehicles = await response.json();
    renderAllTable(vehicles);
  } catch (error) {
    console.error("Error loading data:", error);
    showMessage("Could not load data. Check if backend is running.");
  }
}

function renderAllTable(list) {
  const tbody = document.querySelector("#allVehicleTable tbody");
  tbody.innerHTML = "";

  list.forEach((v, index) => {
    const nocDisplay = v.noc ? v.noc : "Not Generated";
    const row = document.createElement("tr");
    row.setAttribute("onclick", `toggleVehicleDetails('${v.vehicleNumber}', this)`);
    row.style.cursor = "pointer";

    row.dataset.vehicleNumber = v.vehicleNumber;
    row.dataset.index = index;

    let actionButtonHtml = "";
    if (v.noc && userRole === "admin") {
      actionButtonHtml = `<button class="noc-pdf-btn" onclick="event.stopPropagation(); generateDirectNOCPDF('${v.vehicleNumber}')">üìÑ NOC PDF</button>`;
    } else if (v.noc) {
      actionButtonHtml = `<span class="noc-na-text">NOC Generated</span>`;
    } else {
      actionButtonHtml = `<span class="noc-na-text">N/A</span>`;
    }

    row.innerHTML = `
      <td>${v.vehicleNumber}</td>
      <td>${v.surname} ${v.firstName}</td>
      <td>${v.loanAg}</td>
      <td>${nocDisplay}</td>
      <td style="text-align:center;">${actionButtonHtml}</td>
    `;

    tbody.appendChild(row);
  });
}

/* ===========================
   SEARCH
=========================== */
function searchInVehicleData() {
  const input = document.getElementById("searchInputData").value.trim().toUpperCase();

  if (!input) {
    showMessage("Enter search term.");
    renderAllTable(vehicles);
    return;
  }

  const filtered = vehicles.filter(v =>
    v.vehicleNumber.toUpperCase().includes(input) ||
    `${v.surname} ${v.firstName}`.toUpperCase().includes(input) ||
    v.loanAg.toUpperCase().includes(input) ||
    (v.noc && v.noc.toUpperCase().includes(input))
  );

  if (filtered.length === 0) showMessage("No records found.");
  renderAllTable(filtered);
}

function resetVehicleDataSearch() {
  document.getElementById("searchInputData").value = "";
  renderAllTable(vehicles);
}

/* ===========================
   ADDRESS + GUARANTOR TOGGLES
=========================== */
function toggleAddressFields(forceHide = false) {
  const addressFields = document.getElementById("addressFields");
  const combinedAddressInput = document.getElementById("combinedAddress");
  const isVisible = addressFields.style.display !== "none";

  if (!isVisible && !forceHide) {
    addressFields.style.display = "block";
    combinedAddressInput.removeAttribute("required");

    ["hNo","addressLine","city","pinCode","state"].forEach(id => {
      document.getElementById(id).required = true;
    });
  } else {
    addressFields.style.display = "none";
    combinedAddressInput.setAttribute("required", "required");

    ["hNo","addressLine","city","pinCode","state"].forEach(id => {
      document.getElementById(id).required = false;
      document.getElementById(id).value = "";
    });
  }
}

function toggleGuarantorFields(forceHide = false) {
  const guarantorFields = document.getElementById("guarantorFields");
  if (forceHide) {
    guarantorFields.style.display = "none";
    ["guarantorSurname","guarantorName","guarantorLoanAg"].forEach(id => document.getElementById(id).value = "");
  } else {
    guarantorFields.style.display =
      (guarantorFields.style.display === "none" || guarantorFields.style.display === "")
        ? "block"
        : "none";
  }
}

/* ===========================
   ADD VEHICLE
=========================== */
async function addVehicle(e) {
  e.preventDefault();

  if (document.getElementById("addressFields").style.display !== "block") {
    showMessage('Please click the "Address" field and enter details.');
    return;
  }

  const phoneNum = document.getElementById("phone").value.trim();
  if (phoneNum.length !== 10 || !/^\d{10}$/.test(phoneNum)) {
    showMessage("Mobile must be 10 digits.");
    return;
  }

  const address =
    `H.No: ${document.getElementById("hNo").value.trim()}\n` +
    `${document.getElementById("addressLine").value.trim()}\n` +
    `${document.getElementById("city").value.trim()} - ${document.getElementById("pinCode").value.trim()}\n` +
    `${document.getElementById("state").value.trim()}`;

  let guarantorDetails = "N/A";
  if (document.getElementById("guarantorFields").style.display === "block") {
    const gSurname = document.getElementById("guarantorSurname").value.trim();
    const gName = document.getElementById("guarantorName").value.trim();
    const gLoanAg = document.getElementById("guarantorLoanAg").value.trim().toUpperCase();
    if (gSurname || gName || gLoanAg) {
      if (!gSurname || !gName || !gLoanAg) {
        showMessage("Guarantor Details are incomplete.");
        return;
      }
      guarantorDetails = `${gSurname} ${gName} | LOAN_AG: ${gLoanAg}`;
    }
  }

  const newVehicle = {
    surname: document.getElementById("surname").value.trim(),
    firstName: document.getElementById("firstName").value.trim(),
    phone: phoneNum,
    address,
    vehicleNumber: document.getElementById("vehicleNumber").value.trim().toUpperCase(),
    loanAg: document.getElementById("loanAg").value.trim().toUpperCase(),
    loanDate: document.getElementById("loanDate").value,
    guarantor: guarantorDetails,
    maker: document.getElementById("maker").value.trim(),
    classification: document.getElementById("classification").value.trim(),
    model: document.getElementById("model").value.trim(),
    chassis: document.getElementById("chassis").value.trim(),
    engine: document.getElementById("engine").value.trim(),
    rto: document.getElementById("rto").value.trim()
  };

  try {
    const response = await fetch(API_BASE_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(newVehicle)
    });

    const result = await response.json();

    if (!response.ok) {
      showMessage(result.message || "Failed to add vehicle.");
      return;
    }

    showMessage("Vehicle added successfully!");
    document.getElementById("vehicleForm").reset();
    toggleAddressFields(true);
    toggleGuarantorFields(true);
    goHome();
  } catch (err) {
    console.error(err);
    showMessage("Failed to add vehicle.");
  }
}

/* ===========================
   DELETE VEHICLE (ADMIN)
=========================== */
function deleteWithPassword() {
  if (userRole !== "admin") {
    showMessage("Access denied.");
    return;
  }

  const vehicleNum = prompt("Enter vehicle number to delete:");
  if (!vehicleNum) return;

  const password = prompt("Enter admin password to confirm deletion:");
  if (password !== ADMIN_PASSWORD) {
    showMessage("Incorrect password!");
    return;
  }

  deleteVehicle(vehicleNum.trim().toUpperCase());
}

async function deleteVehicle(vehicleNumber) {
  try {
    const response = await fetch(`${API_BASE_URL}/${vehicleNumber}`, { method: "DELETE" });
    if (!response.ok) throw new Error("Failed");
    showMessage("Vehicle deleted successfully!");
    fetchAndRenderAllData();
  } catch (err) {
    console.error(err);
    showMessage("Failed to delete vehicle.");
  }
}

/* ===========================
   PLACEHOLDER FUNCTIONS
   (You already had NOC + PDF logic in old file)
=========================== */
function toggleVehicleDetails() {
  showMessage("Vehicle details expand feature removed in this short version.");
}
function generateDirectNOCPDF() {
  showMessage("NOC PDF feature needs your original long code.");
}
function printVehicleData() {
  showMessage("Print feature needs your original long code.");
}
</script>

</body>
</html>
